workflows:
  android-app:
    name: Android app
    environment:    
      java: 17.0.11
      groups:
      - browserstack
    triggering:
      events:
        - tag
      tag_patterns:
        - pattern: '*'
          include: true
    scripts:
      - script: chmod +x ./gradlew
      - script: ./gradlew assembleRelease
      - name: Prepare BrowserStack Config
        script: |
          sed -i "s/\${userName}/$userName/g; s/\${accessKey}/$accessKey/g" appium_tests/android/browserstack.yml
      - name: MANUAL Upload APK to BrowserStack
        script: |
          response=$(curl -u "${userName}:${accessKey}" \
          -X POST "https://api-cloud.browserstack.com/app-automate/upload" \
          -F "file=@./appium_tests/android/Skelton App Final.apk" \
          -F "custom_id=trc-skeleton-app") 
          echo "export APP_URL=$(echo $response | jq -r '.app_url')" > app_url.sh
          echo $response > temp.sh
      - name: Install BrowserStack SDK and Run Tests
        script: |
          cd ./appium_tests/android
          pip install browserstack-sdk
          browserstack-sdk pytest pytest_main.py
          
    artifacts:
      - app/build/outputs/apk/release/*.apk
